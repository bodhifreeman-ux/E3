version: '3.8'

services:
  # E3 DevMind AI Core
  devmind:
    build: .
    container_name: e3-devmind-ai
    ports:
      - "8000:8000"  # REST API
      - "8001:8001"  # WebSocket
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CSDL_VLLM_URL=http://csdl-vllm:8002
      - QDRANT_HOST=qdrant
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - DATABASE_URL=postgresql://devmind:${POSTGRES_PASSWORD}@postgres:5432/e3_devmind
    volumes:
      - ./e3_knowledge:/app/knowledge
      - ./logs:/app/logs
      - ./models:/app/models
    depends_on:
      - qdrant
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - devmind-network
    # Uncomment for GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # CSDL-vLLM (Custom LLM) - Placeholder
  # NOTE: This requires the CSDL-vLLM repository to be cloned
  # at ../CSDL-vLLM relative to this directory
  # Uncomment when CSDL-vLLM is available
  # csdl-vllm:
  #   build:
  #     context: ../CSDL-vLLM
  #     dockerfile: Dockerfile
  #   container_name: csdl-vllm
  #   ports:
  #     - "8002:8002"
  #   environment:
  #     - MODEL_PATH=/models/csdl-vllm
  #     - MAX_MODEL_LEN=8192
  #     - GPU_MEMORY_UTILIZATION=0.9
  #   volumes:
  #     - ./models:/models
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]
  #   restart: unless-stopped
  #   networks:
  #     - devmind-network

  # Vector Database (Qdrant)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: devmind-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped
    networks:
      - devmind-network

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: devmind-postgres
    environment:
      - POSTGRES_DB=e3_devmind
      - POSTGRES_USER=devmind
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - devmind-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devmind"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: devmind-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - devmind-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Celery Worker (async tasks)
  celery-worker:
    build: .
    container_name: devmind-celery
    command: celery -A devmind_core.tasks worker --loglevel=info --concurrency=4
    environment:
      - REDIS_HOST=redis
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://devmind:${POSTGRES_PASSWORD}@postgres:5432/e3_devmind
    volumes:
      - ./e3_knowledge:/app/knowledge
      - ./logs:/app/logs
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    networks:
      - devmind-network

volumes:
  qdrant_storage:
  postgres_data:
  redis_data:

networks:
  devmind-network:
    driver: bridge
